#!/bin/bash
AK_CATEGORIES="$AK_WORKDIR/categories"
PROGRAM="$(basename $0)"

echo $AK_CATEGORIES
if [ ! -d $AK_CATEGORIES ]; then
	mkdir $AK_CATEGORIES
	cd $AK_CATEGORIES
	echo "AK_CATEGORIES created"
else
	echo "AK_CATEGORIES found"
fi

_ak_modules_categories_create(){
    TEMP="$(ak-tempassin)"
    cd $TEMP
	export NEWS_FILE="$(date +%Y%m%d_%H%M%S)"
	vi $NEWS_FILE
	echo "Renaming..."
	TITLE="$(head -n 1 $NEWS_FILE)"
	TO_FILE=$NEWS_FILE-$(echo $TITLE | tr '[:upper:]' '[:lower:]' | sed -e 's/ /\_/g' )
	IPFS_FILE=$(ak-ipfs-add $NEWS_FILE)
	mv $NEWS_FILE $AK_CATEGORIES/$TO_FILE
	sed -e 's,Qm.*,'"$IPFS_FILE"',g' $AK_CATEGORIES/README
	_ak_modules_categories_add $AK_CATEGORIES/$TO_FILE
	cd $AK_CATEGORIES
}
_ak_modules_categories_index(){
	FILES="$(ls -1 $AK_CATEGORIES)"
	i=0
	for FILE in $FILES
	do
		DATE=$(echo $FILE | cut -d - -f 1 | awk '{print $1}')
		TITLE=$(head -n 1 $AK_CATEGORIES/$FILE)
		echo $i \| $DATE \| $TITLE
		let i+=1
	done	
}
_ak_modules_categories_title(){
    echo "$PROGRAM"
}

_ak_modules_categories_import(){
	echo "#TODO"
	if [ ! -z $1 ]
	then
		if [ ! -d $1 ]
		then
			echo "Folder does not exists"
			exit 4
		else
			echo "Folder $1 exists"
			fl="$(ls -1 $1)"
			for f in $fl
			do
				_ak_modules_categories_add $1/$f
			done
		fi
	else
		echo "No value"
		exit 6
	fi
	exit 224
}
_ak_modules_categories_add(){
    TEMP="$(ak-tempassin)"
    cd $TEMP
	if [ -f $1 ]; then
		FILE="$1"
		echo "Adding news from " $FILE
		DATETIME=$(echo $FILE | cut -d - -f 1 | awk '{print $1}')
		TITLE=$(head -n 1 $FILE)
		FILE_IPFS_HASH=$(ak-ipfs-add $FILE)
		FILE_SIGN_FILE=$FILE".asc"
		gpg2 --homedir $AK_GPGHOME --detach-sign --sign-with $AK_FINGERPRINT --armor --output $FILE_SIGN_FILE $FILE
		FILE_SIGNATURE=$(ak-ipfs-add $FILE_SIGN_FILE)
		cat > data <<EOF
{
   "datetime":"$DATETIME",
   "title":"$TITLE",
   "filename":"$FILE",
   "ipfs":"$FILE_IPFS_HASH",
   "detach":"$FILE_SIGNATURE"
}
EOF
	else
		echo "File $FILE doesn't exist";
		exit 2
	fi
    ak-zblock-pack "news/add" $(pwd)/data
	if [ $? == 0 ]
	then
		echo "News added successfully"
	else
		echo "error??"
		exit 1
	fi
}
_ak_modules_categories_usage(){
	echo "#TODO"
	echo "All you need to know is that there are two options available:"
	echo "help		Prints this help message"
	echo "index		Prints an indexed table of your news files"
	echo "import <file>	#TODO"
	echo "add <file>	Creates a data file from the news file you point to"
	echo "create		Vim is going to pop up, you will write and save your"
	echo "                  newsletter and it's going to be saved"
	exit 0
}
_ak_modules_categories_title
if [ ! -z $1 ]; then
	case $1 in
		help) _ak_modules_categories_usage; exit;;
		index) _ak_modules_categories_index; exit;;
		import) _ak_modules_categories_import $2; exit;;
		add) _ak_modules_categories_add $2; exit;;
        create) _ak_modules_categories_create; exit;;
		* ) _ak_modules_categories_usage;;
	esac
else _ak_modules_categories_usage
fi
