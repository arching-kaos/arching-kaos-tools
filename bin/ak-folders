#!/bin/bash
# The following creates a mixtape data message
PROGRAM="$(basename $0)"
ZFOLDERSDIR="$AK_WORKDIR/folders"
TEMP="/tmp/aktmp"

logit(){
    ak-logthis "<$PROGRAM>" "$1" "$2"
}

if [ ! -d $ZFOLDERSDIR ]; then
    mkdir $ZFOLDERSDIR
    cd $ZFOLDERSDIR
else
    logit "[ERROR]" "error $ZFOLDERSDIR not found or/and could not be created"
fi
TEMPASSIN="$(ak-tempassin)"
cd $TEMPASSIN

usage(){
    title
    echo "$PROGRAM - folder"
}

add(){
    CRP="$(pwd)"
    FOLDERNAME="$1"
    main $FOLDERNAME $CRP
    cat data | jq -M
}

main(){
    FOLDERNAME="$1"
    CRP="$2"
    echo "Adding $FOLDERNAME"
    logit "[INFO]" "Copying $1 to temporary folder"
    cp -r $2/$1 $1
    if [ $? == 0 ]; then
        logit "[INFO]" "Copied successfully"
    else
        logit "[ERROR]" "Error copying..."
    fi

    FOLDER="$1"

    logit "[INFO]" "Adding $FOLDER to IPFS..."
    FOLDER_IPFS_HASH=$(ak-ipfs-add $FOLDER)
    if [ $? == 0 ]; then
        logit "[INFO]" "done"
    else
        logit "[ERROR]" "error"
    fi
    logit "[WARNING]" "Folders are not signing..."

    printf '{"timestamp":"%s","foldername":"%s","ipfs":"%s"}' $(date -u +%s) $FOLDERNAME $FOLDER_IPFS_HASH

    echo "Printing data..."
    cat data
    echo "Publishing..."

    ak-pack_z_block folders/add $(pwd)/data
    if [ $? == 0 ]
    then
        echo "cool"
    else
        echo "not?"
        exit 2
    fi
}

title(){
    echo "$PROGRAM"
    echo "Folder block creator"
}


if [ ! -z $1 ]; then
    case $1 in
        help) usage; exit;;
        add) add $2; exit;;
        *) usage; exit;;
    esac
else usage
fi
